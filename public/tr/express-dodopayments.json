{
  "name": "express-dodopayments",
  "description": "DodoPayments template for Express.js",
  "framework": "express",
  "files": [
    {
      "target": "lib/dodopayments.ts",
      "type": "template",
      "content": "import { DodoPayments } from 'dodopayments'\n\nlet dodopaymentsClient: DodoPayments | null = null\n\nexport function getDodoPaymentsClient(): DodoPayments {\n  if (!dodopaymentsClient) {\n    const token = process.env.DODO_PAYMENTS_API_KEY\n    const environment = process.env.DODO_PAYMENTS_ENVIRONMENT as \"live_mode\" | \"test_mode\"\n\n    if (!token) {\n      throw new Error(`\n        DODO_PAYMENTS_API_KEY environment variable is missing.\n        \n        Please check:\n        1. Your .env file exists in the project root\n        2. The file contains: DODO_PAYMENTS_API_KEY=<your-api-key>\n        3. You've restarted your development server\n        4. No extra quotes or spaces in the .env file\n      `)\n    }\n\n    if (!environment || (environment !== \"live_mode\" && environment !== \"test_mode\")) {\n      throw new Error('DODO_PAYMENTS_ENVIRONMENT must be either \"live_mode\" or \"test_mode\"')\n    }\n\n    dodopaymentsClient = new DodoPayments({\n      bearerToken: token,\n      environment: environment,\n    })\n  }\n\n  return dodopaymentsClient\n}\n"
    },
    {
      "target": "routes/dodopayments/route.ts",
      "type": "template",
      "content": "import express from 'express';\nimport { checkoutRouter } from './checkout';\nimport { customerRouter } from './customer';\nimport { paymentsRouter } from './payments';\nimport { productsRouter } from './products';\nimport { subscriptionsRouter } from './subscriptions';\nimport { webhookRouter } from './webhook';\n\nconst router = express.Router();\n\nrouter.use('/checkout', checkoutRouter);\nrouter.use('/customer', customerRouter);\nrouter.use('/payments', paymentsRouter);\nrouter.use('/products', productsRouter);\nrouter.use('/subscriptions', subscriptionsRouter);\nrouter.use('/webhook', webhookRouter);\n\nexport { router as dodopaymentsRouter };\n"
    },
    {
      "target": "routes/dodopayments/checkout.ts",
      "type": "template",
      "content": "import express from 'express';\nimport { getDodoPaymentsClient } from '../../lib/dodopayments';\nimport { DodoPayments } from 'dodopayments';\nimport { z } from 'zod';\n\nconst router = express.Router();\n\nconst productCartItemSchema = z.object({\n    product_id: z.string().min(1, \"Product ID is required\"),\n    quantity: z.number().int().min(1, \"Quantity must be at least 1\"),\n    amount: z.number().int().min(0).optional(),\n});\n\nconst attachExistingCustomerSchema = z.object({\n    customer_id: z.string().min(1, \"Customer ID is required\"),\n});\n\nconst newCustomerSchema = z.object({\n    email: z.string().email(\"Invalid email format\"),\n    name: z.string().min(1, \"Name is required\"),\n    phone_number: z.string().optional().nullable(),\n    create_new_customer: z.boolean().optional(),\n});\n\nconst customerSchema = z.union([attachExistingCustomerSchema, newCustomerSchema]);\n\nconst billingAddressSchema = z.object({\n    city: z.string().min(1, \"City is required\"),\n    country: z.string().regex(/^[A-Z]{2}$/, \"Country must be a 2-letter uppercase ISO code\"),\n    state: z.string().min(1, \"State is required\"),\n    street: z.string().min(1, \"Street address is required\"),\n    zipcode: z.string().min(1, \"Zipcode is required\"),\n});\n\nconst checkoutSessionSchema = z.object({\n    productCart: z.array(productCartItemSchema).min(1, \"At least one product is required\"),\n    customer: customerSchema,\n    billing_address: billingAddressSchema,\n    return_url: z.string().url(\"Return URL must be a valid URL\"),\n    customMetadata: z.record(z.string(), z.string()).optional(),\n});\n\nrouter.post('/', async (req, res) => {\n    try {\n        const validationResult = checkoutSessionSchema.safeParse(req.body);\n        if (!validationResult.success) {\n            return res.status(400).json({\n                error: \"Validation failed\",\n                details: validationResult.error.issues.map(issue => ({\n                    field: issue.path.join('.'),\n                    message: issue.message\n                }))\n            });\n        }\n\n        const { productCart, customer, billing_address, return_url, customMetadata } = validationResult.data;\n\n        const session = await getDodoPaymentsClient().checkoutSessions.create({\n            product_cart: productCart,\n            customer: customer,\n            billing_address: billing_address as DodoPayments.Payments.BillingAddress,\n            return_url: return_url,\n            metadata: customMetadata,\n        });\n\n        res.json(session);\n    } catch (error) {\n        console.error('Error in checkout POST handler:', error);\n        res.status(500).json({ error: 'Internal server error' });\n    }\n});\n\nexport { router as checkoutRouter };\n"
    },
    {
      "target": "routes/dodopayments/customer.ts",
      "type": "template",
      "content": "import express from 'express';\nimport { getDodoPaymentsClient } from '../../lib/dodopayments';\nimport { z } from 'zod';\n\nconst router = express.Router();\n\nconst customerCreateSchema = z.object({\n    email: z.string().email(\"Invalid email format\"),\n    name: z.string().min(1, \"Name is required\"),\n    phone_number: z.string().optional().nullable(),\n});\n\nconst customerUpdateSchema = z.object({\n    email: z.string().email(\"Invalid email format\").optional(),\n    name: z.string().min(1, \"Name is required\").optional(),\n    phone_number: z.string().optional().nullable(),\n});\n\nrouter.get('/', async (req, res) => {\n    try {\n        const { customer_id } = req.query;\n\n        if (!customer_id || typeof customer_id !== 'string') {\n            return res.status(400).json({ error: 'customer_id is required' });\n        }\n\n        const customer = await getDodoPaymentsClient().customers.retrieve(customer_id);\n        res.json(customer);\n    } catch (error) {\n        console.error('Error fetching customer:', error);\n        res.status(500).json({ error: 'Internal server error' });\n    }\n});\n\nrouter.post('/', async (req, res) => {\n    try {\n        const validationResult = customerCreateSchema.safeParse(req.body);\n        if (!validationResult.success) {\n            return res.status(400).json({\n                error: \"Validation failed\",\n                details: validationResult.error.issues.map(issue => ({\n                    field: issue.path.join('.'),\n                    message: issue.message\n                }))\n            });\n        }\n\n        const customer = await getDodoPaymentsClient().customers.create(validationResult.data);\n        res.json(customer);\n    } catch (error) {\n        console.error('Error creating customer:', error);\n        res.status(500).json({ error: 'Internal server error' });\n    }\n});\n\nrouter.put('/', async (req, res) => {\n    try {\n        const { customer_id } = req.query;\n\n        if (!customer_id || typeof customer_id !== 'string') {\n            return res.status(400).json({ error: 'customer_id is required' });\n        }\n\n        const validationResult = customerUpdateSchema.safeParse(req.body);\n        if (!validationResult.success) {\n            return res.status(400).json({\n                error: \"Validation failed\",\n                details: validationResult.error.issues.map(issue => ({\n                    field: issue.path.join('.'),\n                    message: issue.message\n                }))\n            });\n        }\n\n        const customer = await getDodoPaymentsClient().customers.update(customer_id, validationResult.data);\n        res.json(customer);\n    } catch (error) {\n        console.error('Error updating customer:', error);\n        res.status(500).json({ error: 'Internal server error' });\n    }\n});\n\nrouter.get('/subscriptions', async (req, res) => {\n    try {\n        const { customer_id } = req.query;\n\n        if (!customer_id || typeof customer_id !== 'string') {\n            return res.status(400).json({ error: 'customer_id is required' });\n        }\n\n        const subscriptions = await getDodoPaymentsClient().subscriptions.list({\n            customer_id: customer_id\n        });\n        res.json(subscriptions);\n    } catch (error) {\n        console.error('Error fetching customer subscriptions:', error);\n        res.status(500).json({ error: 'Internal server error' });\n    }\n});\n\nrouter.get('/payments', async (req, res) => {\n    try {\n        const { customer_id } = req.query;\n\n        if (!customer_id || typeof customer_id !== 'string') {\n            return res.status(400).json({ error: 'customer_id is required' });\n        }\n\n        const payments = await getDodoPaymentsClient().payments.list({\n            customer_id: customer_id\n        });\n        res.json(payments);\n    } catch (error) {\n        console.error('Error fetching customer payments:', error);\n        res.status(500).json({ error: 'Internal server error' });\n    }\n});\n\nexport { router as customerRouter };\n"
    },
    {
      "target": "routes/dodopayments/payments.ts",
      "type": "template",
      "content": "import express from 'express';\nimport { getDodoPaymentsClient } from '../../lib/dodopayments';\n\nconst router = express.Router();\n\nrouter.get('/', async (req, res) => {\n    try {\n        const { payment_id } = req.query;\n\n        if (!payment_id || typeof payment_id !== 'string') {\n            return res.status(400).json({ error: 'payment_id is required' });\n        }\n\n        const payment = await getDodoPaymentsClient().payments.retrieve(payment_id);\n        res.json(payment);\n    } catch (error) {\n        console.error('Error fetching payment:', error);\n        res.status(500).json({ error: 'Internal server error' });\n    }\n});\n\nrouter.get('/list', async (req, res) => {\n    try {\n        const { customer_id, limit, starting_after } = req.query;\n\n        const params: any = {};\n        if (customer_id && typeof customer_id === 'string') {\n            params.customer_id = customer_id;\n        }\n        if (limit && typeof limit === 'string') {\n            params.limit = parseInt(limit);\n        }\n        if (starting_after && typeof starting_after === 'string') {\n            params.starting_after = starting_after;\n        }\n\n        const payments = await getDodoPaymentsClient().payments.list(params);\n        res.json(payments);\n    } catch (error) {\n        console.error('Error fetching payments list:', error);\n        res.status(500).json({ error: 'Internal server error' });\n    }\n});\n\nexport { router as paymentsRouter };\n"
    },
    {
      "target": "routes/dodopayments/products.ts",
      "type": "template",
      "content": "import express from 'express';\nimport { getDodoPaymentsClient } from '../../lib/dodopayments';\n\nconst router = express.Router();\n\nrouter.get('/', async (req, res) => {\n    try {\n        const { limit, starting_after } = req.query;\n\n        const params: any = {};\n        if (limit && typeof limit === 'string') {\n            params.limit = parseInt(limit);\n        }\n        if (starting_after && typeof starting_after === 'string') {\n            params.starting_after = starting_after;\n        }\n\n        const products = await getDodoPaymentsClient().products.list(params);\n        res.json(products);\n    } catch (error) {\n        console.error('Error fetching products:', error);\n        res.status(500).json({ error: 'Internal server error' });\n    }\n});\n\n\nrouter.get('/product', async (req, res) => {\n    try {\n        const { product_id } = req.query;\n\n        if (!product_id || typeof product_id !== 'string') {\n            return res.status(400).json({ error: 'product_id is required' });\n        }\n\n        const product = await getDodoPaymentsClient().products.retrieve(product_id);\n        res.json(product);\n    } catch (error) {\n        console.error('Error fetching product:', error);\n        res.status(500).json({ error: 'Internal server error' });\n    }\n});\n\nexport { router as productsRouter };\n"
    },
    {
      "target": "routes/dodopayments/subscriptions.ts",
      "type": "template",
      "content": "import express from 'express';\nimport { getDodoPaymentsClient } from '../../lib/dodopayments';\n\nconst router = express.Router();\n\nrouter.get('/', async (req, res) => {\n    try {\n        const { subscription_id } = req.query;\n\n        if (!subscription_id || typeof subscription_id !== 'string') {\n            return res.status(400).json({ error: 'subscription_id is required' });\n        }\n\n        const subscription = await getDodoPaymentsClient().subscriptions.retrieve(subscription_id);\n        res.json(subscription);\n    } catch (error) {\n        console.error('Error fetching subscription:', error);\n        res.status(500).json({ error: 'Internal server error' });\n    }\n});\n\nrouter.get('/list', async (req, res) => {\n    try {\n        const { customer_id, limit, starting_after } = req.query;\n\n        const params: any = {};\n        if (customer_id && typeof customer_id === 'string') {\n            params.customer_id = customer_id;\n        }\n        if (limit && typeof limit === 'string') {\n            params.limit = parseInt(limit);\n        }\n        if (starting_after && typeof starting_after === 'string') {\n            params.starting_after = starting_after;\n        }\n\n        const subscriptions = await getDodoPaymentsClient().subscriptions.list(params);\n        res.json(subscriptions);\n    } catch (error) {\n        console.error('Error fetching subscriptions list:', error);\n        res.status(500).json({ error: 'Internal server error' });\n    }\n});\n\nexport { router as subscriptionsRouter };\n"
    },
    {
      "target": "routes/dodopayments/webhook.ts",
      "type": "template",
      "content": "import express from 'express';\nimport { Webhook } from \"standardwebhooks\";\nimport { getDodoPaymentsClient } from '../../lib/dodopayments';\n\nconst router = express.Router();\n\nconst webhook = new Webhook(process.env.DODO_PAYMENTS_WEBHOOK_KEY!);\n\nrouter.post('/', express.raw({ type: 'application/json' }), async (req, res) => {\n    try {\n        const rawBody = req.body;\n        const webhookHeaders = {\n            \"webhook-id\": req.headers[\"webhook-id\"] as string || \"\",\n            \"webhook-signature\": req.headers[\"webhook-signature\"] as string || \"\",\n            \"webhook-timestamp\": req.headers[\"webhook-timestamp\"] as string || \"\",\n        };\n\n        await webhook.verify(rawBody, webhookHeaders);\n        const payload = JSON.parse(rawBody.toString());\n\n        if (payload.data.payload_type === \"Subscription\") {\n            switch (payload.type) {\n                case \"subscription.active\":\n                    const subscription = await getDodoPaymentsClient().subscriptions.retrieve(payload.data.subscription_id);\n                    console.log(\"-------SUBSCRIPTION DATA START ---------\")\n                    console.log(subscription)\n                    console.log(\"-------SUBSCRIPTION DATA END ---------\")\n                    break;\n                case \"subscription.failed\":\n                    console.log(\"Subscription failed:\", payload.data.subscription_id);\n                    break;\n                case \"subscription.cancelled\":\n                    console.log(\"Subscription cancelled:\", payload.data.subscription_id);\n                    break;\n                case \"subscription.renewed\":\n                    console.log(\"Subscription renewed:\", payload.data.subscription_id);\n                    break;\n                case \"subscription.on_hold\":\n                    console.log(\"Subscription on hold:\", payload.data.subscription_id);\n                    break;\n                default:\n                    console.log(\"Unknown subscription event:\", payload.type);\n                    break;\n            }\n        } else if (payload.data.payload_type === \"Payment\") {\n            switch (payload.type) {\n                case \"payment.succeeded\":\n                    const paymentDataResp = await getDodoPaymentsClient().payments.retrieve(payload.data.payment_id)\n                    console.log(\"-------PAYMENT DATA START ---------\")\n                    console.log(paymentDataResp)\n                    console.log(\"-------PAYMENT DATA END ---------\")\n                    break;\n                case \"payment.failed\":\n                    console.log(\"Payment failed:\", payload.data.payment_id);\n                    break;\n                case \"payment.refunded\":\n                    console.log(\"Payment refunded:\", payload.data.payment_id);\n                    break;\n                default:\n                    console.log(\"Unknown payment event:\", payload.type);\n                    break;\n            }\n        }\n\n        res.status(200).json({ message: \"Webhook processed successfully\" });\n    } catch (error) {\n        console.error(\"Webhook verification failed:\", error);\n        res.status(400).json({ error: \"Webhook verification failed\" });\n    }\n});\n\nexport { router as webhookRouter };\n"
    },
    {
      "target": ".env.example",
      "type": "template",
      "content": "# DodoPayments Configuration\nDODO_PAYMENTS_API_KEY=your_api_key_here\nDODO_PAYMENTS_ENVIRONMENT=test_mode\nDODO_PAYMENTS_WEBHOOK_KEY=your_webhook_key_here\n\n# Server Configuration\nPORT=3000\nNODE_ENV=development\n"
    }
  ],
  "dependencies": [
    "dodopayments",
    "standardwebhooks",
    "zod",
    "express",
    "@types/express"
  ]
}